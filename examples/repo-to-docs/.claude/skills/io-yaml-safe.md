---
name: io-yaml-safe
type: atomic
version: v1.0
description: "Safe YAML file writing with validation"
---

# IO YAML Safe

## Purpose

Ensure YAML files are written correctly with proper structure, validation, and atomic writes. Prevent corrupted or invalid output.

## Procedure

### Step 1: Validate Structure

Before writing:
- Ensure data is valid YAML-serializable
- Check required fields present
- Validate against schema (if provided)

### Step 2: Format Content

```yaml
# Header comment with context
# Generated by: {agent_name}
# Created at: {timestamp}

{content}
```

### Step 3: Write Atomically

1. Write to temporary file first
2. Validate written content is readable
3. Move to final location

### Step 4: Verify

After write:
- Read back the file
- Ensure content matches intent
- Log success/failure

## YAML Best Practices

### Use Block Scalars for Multi-line

```yaml
# Good
description: |
  This is a long description
  that spans multiple lines.

# Bad
description: "This is a long description\nthat spans multiple lines."
```

### Quote Strings When Needed

```yaml
# These need quotes
title: "Yes"           # Would be boolean
version: "1.0"         # Could be float
path: "C:\\Users"      # Contains backslash

# These don't need quotes
name: my-agent
count: 42
```

### Consistent Indentation

Always use 2 spaces, never tabs.

### Arrays

```yaml
# Preferred for short items
tags: [tech, research, ai]

# Use block for complex items
items:
  - id: 1
    name: First
  - id: 2
    name: Second
```

## Error Handling

| Error | Action |
|-------|--------|
| Invalid YAML structure | Invoke yaml-repair (max 2 attempts) |
| Schema validation fail | Log specific fields, do not write |
| Write permission denied | Propagate error to caller |
| Disk full | Propagate error to caller |

## Self-Correction Loop

When YAML validation fails, invoke the yaml-repair skill:

```
1. Validate YAML before write
2. If invalid:
   a. Extract parse error message
   b. Invoke yaml-repair skill:
      Skill(skill: "yaml-repair", args: |
        broken_yaml: {raw_yaml}
        parse_error: {error_message}
        attempt: 1
      )
   c. Receive repaired YAML
   d. Re-validate
3. If still invalid after repair:
   a. Invoke yaml-repair again (attempt: 2)
   b. Re-validate
4. If still invalid after 2 attempts:
   a. HALT - do not write
   b. Report error with both attempts logged
   c. Suggest manual intervention
5. If valid → proceed with write
```

### Repair Integration Flow

```
Agent writes YAML
        │
        ▼
   Validate Structure
        │
   ┌────┴────┐
   │  Valid  │──────────────────▶ Write File
   └─────────┘
        │
   Invalid (parse error)
        │
        ▼
┌─────────────────────┐
│   yaml-repair       │
│   attempt: 1        │
└──────────┬──────────┘
           │
           ▼
      Re-validate
           │
     ┌─────┴─────┐
     │  Valid    │──────────────▶ Write File
     └───────────┘
           │
     Still invalid
           │
           ▼
┌─────────────────────┐
│   yaml-repair       │
│   attempt: 2        │
└──────────┬──────────┘
           │
           ▼
      Re-validate
           │
     ┌─────┴─────┐
     │  Valid    │──────────────▶ Write File
     └───────────┘
           │
     Still invalid
           │
           ▼
      HALT + Report Error
```

## Integration

All agents writing YAML output should:
1. Include this skill in required skills
2. Use Write tool for output
3. Follow formatting guidelines
4. Include metadata section
5. Trust yaml-repair for automatic correction
